{% extends 'base/base.html' %}

{% block content %}
<div class="container mt-5">
    <div class="row justify-content-center">
        <div class="col-md-8 text-center">
            <h2>Downloading {{ resource.title }}</h2>
            <p>Your file is being prepared for download...</p>
            <div class="spinner-border text-primary mb-4" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p class="mt-3">If the download doesn't start automatically, <a href="{{ file_url }}" download class="btn btn-primary">click here</a></p>
        </div>
    </div>
</div>

<script>
    // Function to open the file in a new tab
    function openInNewTab(url) {
        window.open(url, '_blank');
    }

    // Function to trigger download
    function downloadFile(url) {
        const a = document.createElement('a');
        a.style.display = 'none';
        a.href = url;
        // Force download attribute
        a.setAttribute('download', '');
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
    }

    // Execute immediately without waiting for window.onload
    (function() {
        const fileUrl = "{{ file_url }}";
        
        // Open in new tab immediately
        openInNewTab(fileUrl);
        
        // Trigger download immediately
        downloadFile(fileUrl);
        
        // Redirect back to resource detail page after a short delay
        setTimeout(function() {
            window.location.href = "{% url 'resource_detail' resource.pk %}";
        }, 1500);
    })();
</script>
{% endblock %}